---
title: Thoughts on Malware (Defense Against the Dark Arts)
path: 'security-malware'
tags: ['school', 'security']
date: "2019-01-11"
---

As part of my effort to obtain a Computer Science degree, I am taking a class called "Defense Against the Dark Arts" on Security topics. I'm actually really excited for this class, both its topics and its approach, which is that the lectures are given by experts who work in the field. As part of the class, I am required to write blog posts each week on the topic, so here I go!

The first week talks about malware (malicious software). I had a small understanding of malware, in that I knew what it is, but I had never thought about it beyond that. This week, the lecturer is from McAfee, and I learned that what the security research team is doing is writing drivers to detect malware, and in their approach to writing these drivers, trying to be able to detect future variations, because there's just so much malware to keep up with.

First we start off with some basic information about malware and definitions:

## Some different types of malware:
* **Viruses** (parasitic - when it depends on another file, polymorphic - code keeps changing) and Worm - (spreads quickly)
* **Trojans** - backdoor (has remote control of system, attacker will be active so it's more targeted than a bot), downloader (has remote control of system), password stealer, keylogger, bot (waits for remote commands) 
* **Potentially Unwanted Program, Adware, Spyware** (PUP, PUA, PUS) (commercial, can install other programs along with one you want)

## Ways to cause infection of malware:
* The biggest risk is people!
* USB sticks
* Mobile apps
* Drive by downloads - such as JavaScript exploit from visiting a website
* PDF
* Office files

## Malware Definitions:
* **White listed** - clean
* **Black** - dirty
* **Grey** - trying to discover what the malware is doing
* **Sample** - piece of malware
* **Goat** - machine used to investigate malware. Some malware knows when it’s running in a VM, so sometimes you want to run on a real system. Goats are sacrificial machines that are on purpose infected.
* **Honeypot** - sitting duck waiting for it to be infected
* **Replication** - what is the malware doing? So we can study its behavior.
* **Hash** - calculating using cryptographic algorithm (commonly md5) the value of a file. It's used to verify values of files. (Is it the same file?)
* **Trojan horse** - users tricked into opening a program because they think it’s legitimate software. Can also create a backdoor that gives users access to your system
* **Spyware** - programs that collect personal info without the user’s knowledge. 
* **Ransom-ware** - encrypts your files and asks for payment to unlock them - bitcoin
* **POS malware** - (point of sale) trying to steal your credit card (Target, Home Depot, Staples)
* **Patient zero** - first attacked

## Naming convention for malware:
```Type of malware + Platform + Family (name in malware) + Variant of Family + ! + information```

-----


The next part was my favorite part of the week, learning about strategies for investigating malware and doing a lab to investigate an actual malware sample. I learned there are different tools out there that you can use to see what is happening, but there's also a lot of basic methods you can use to poke around the system.

# Strategies to replicate/investigate malware:

##Before Starting:
* Transport it in an inactive state by renaming it using the command line (ie remove '.exe' so it won't execute)
* Have isolated environment so it doesn't destroy anything you need
* Take a snapshot of your machine before you start, so you can easily revert back to a clean state.

##General Research Tactics:
* Upload/check sites: You can hash the file and upload to different sites to see if anyone else has encountered the malware. Virustotal, Malwr, Wepawet, Comodo are examples of sites.
* Compare snapshot before and after running it to see what is changing
* Bait the malware with what it’s looking for (ie if it's trying to steal credit card numbers, feed it some fake credit card numbers)
* Check PE file (starts with MZ) - headers, directories, section tables, code, imports, data
* Do a text analysis by searching google (maybe someone has a username and posted online, or you find an IP address you can investigate)

##Built in Windows tools you can use to investigate:
* Task Manager
* MS Config
* Command Prompts - IPconfig/displayDNS
* Windows search for the time when last files were added to system 
* Task Scheduler
* Registry - because malware wants to survive a reboot, it might add run keys in registry
* attrib <filename>
* Process Explorer - Task manager/system monitor
* Process monitor - monitor all changes on system like opening files. File and capture events, search for Evil.exe.

##Other tools we're using in class:
* Flypaper - block TCP/IP connections and blocks program from exiting
* Fake Net - listening on several ports
* Antispy - detect spyware

##Static analysis techniques:
* Open the program in text editor and analyze source code
* Open in IDA Pro - tool to disassemble code and to see how it is running
* XOR encryption - check for bit flipping (sometimes authors will flip values to hide things)
* File Insight - A Mcafee tool where you can try to make the code more readable by checking for bit flipping, swapping, and string dumps
* Packer - some malware is compressed and/or encrpyted, so you need to use a packer to return it to its readable state

-----
Next the lectures talked about APT, or Advanced Persistent Threats.

##APT

* **Advanced** - attacker is fluent with techniques
* **Persistent** - attacker has an objective and works to achieve goals without detection
* **Threats** - attacker is organized, receives instructions, funded/motivated
* **Actors** - can be activists, governments, organized crime groups, competitions, malicious insiders or ex employees
* **Motives** - money, revenge, ideology, excitement
* **Targets** - corporations, governments, defense contractors, anyone
* **Goals** - use stealth to avoid detection, create backdoors to allow greater access, initiate primary mission, leave undetected
* **Kill chain** - reconnaissance, weaponization, delivery, exploitation, installation, command and control, actions on objectives

-----

The last topic was also really interesting to me: reconnaissance. The lectures talked about ways someone could go about planning an attack to get information. It's scary how easy it is.

* You can research people at the company on LinkedIn to find out who works there and the way the company structures their email addresses.
* You can research what those users visit, what vendors they use, and send fake emails where you get people to click (water hole attack)
* You can find a lot about what technologies a company is using (on job listings you can see what software they are using; check metadata in files published online (version of pdfs, word, OS, etc)
* Delivery - you can implement a fake wifi, something that requires Facebook login, that people at the company may use and you can then infect them
