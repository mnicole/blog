{"data":{"site":{"siteMetadata":{"title":"Thoughts on Things","author":"Michele Larson"}},"markdownRemark":{"id":"03123aa6-6301-546c-95a4-4f2c5b10c124","excerpt":"This week focuses on how to investigating security incidents. You should be aware of the best way to investigate it while being careful to preserve evidence…","html":"<p>This week focuses on how to investigating security incidents. You should be aware of the best way to investigate it while being careful to preserve evidence.</p>\n<p><strong>Side note - the lecturer talks about the book, <a href=\"https://www.goodreads.com/book/show/18154.The_Cuckoo_s_Egg\">The Cuckoo’s Egg</a>. I read it last year and loved it!</strong></p>\n<h3>Types of cases you may investigate</h3>\n<ul>\n<li>Fraud</li>\n<li>Intellectual Property</li>\n<li>Hacker Intrusions/Data Breaches</li>\n<li>Inappropriate use of Internet</li>\n<li>Child Exploitation</li>\n<li>eDiscovery supporting Civil or Criminal Litigation</li>\n</ul>\n<h3>Stages of Investigation</h3>\n<ol>\n<li>Evidence acquisition</li>\n<li>Investigation and Analysis</li>\n<li>Reporting results</li>\n</ol>\n<h3>Forensics</h3>\n<ul>\n<li>Includes: Identifying, preserving, analyzing evidence and presenting results.</li>\n<li>Could find evidence in network, operating system, databases and applications, peripherals, removable media, human testimony</li>\n<li>To keep in mind: It’s not up to you to judge guilt. It’s up to you to show what happened. If you think someone is guilty, you look for information to prove your opinion, so it can make you biased while investigating.</li>\n<li>Need to describe results in a way that a judge will understand. Something the lecturer does is ask questions like an attorney to see if there’s anything a judge might ask that they can clarify now.</li>\n<li>Always check times and keep records of times.</li>\n<li>Any time you do anything, it affects the memory and could erase something.</li>\n<li>Locard’s Exchange Principle - when two things interact, there is always transference of material. Thoroughly document anything you do on a live system.</li>\n<li>Triage - There may be different ways to do something. You should check multiple ways to make sure you can come to the same conclusion.</li>\n<li>You can’t log into accounts even if you come across the username and password. You need permission from a judge. It has to be relevant to the case.</li>\n<li>Harddrives are giant and there may be a time limit. You also might get additional harddrives, portable harddrives, cell phones, etc. It takes time to process the data.</li>\n<li>Whitelisting is good to match checksums and verify files are ok and you don’t have to waste time investigating them. The person processing the harddrive will do a checksum of the entire harddrive. The first thing you should do is check that to make sure the evidence wasn’t tampered with.</li>\n</ul>\n<h3>Incident Response Process</h3>\n<ol start=\"0\">\n<li>Incident Response Team Preparation</li>\n<li>Incident Detection</li>\n<li>Initial Response</li>\n<li>Formulate Response Strategy</li>\n<li>Investigate the Incident\n4a. Data Collection\n4b. Forensic Analysis\n4c. Perform Non-Forensic Investigation</li>\n<li>Document Findings\n5a. Administrative Action</li>\n</ol>\n<h3>APT Case Evidence</h3>\n<ul>\n<li>Reconnaissance: Firewall/IPS logs</li>\n<li>Delivery - Email Gateways logs, proxy logs, internet history, Java-IDX files</li>\n<li>Exploitation - Windows Event logs, crash dump files</li>\n<li>Installation - $MFT, memory dump registry, prefetch-files</li>\n<li>Command and Control - Memory dump, firewall logs, proxy logs, netflow</li>\n<li>Actions on Objectives - $MFT, memory dump registry, prefetch files, netflow, remote tools</li>\n</ul>\n<p><em>Initial Response - Shutting off the machine can destroy evidence, but you should pull network cable or block port (attacker may be on network still, even watching you!)</em></p>\n<h5>Order of Volatility - RFC 3227</h5>\n<ul>\n<li>Gather evidence in specific order, capturing the most volatile things first</li>\n<li>System memory</li>\n<li>Temporary file systems</li>\n<li>Process Table and Network Connections</li>\n<li>Network Routing Information and ARP cache</li>\n<li>Forensices Acquisition of Disks</li>\n<li>Remote Logging and monitoring data</li>\n<li>Physical config and network topology</li>\n<li>Backups</li>\n<li>Non volatile data (Time/Data stamps, event logs, web/application logs, registry)</li>\n<li>Relevant logical files (Unknown executables, attacker tools, any other files related to incident)</li>\n</ul>\n<h4>FTK Imager</h4>\n<ul>\n<li>Easy free tool, to dump memory, but leaves an imprint in memory so it’s better to do with commands.</li>\n<li>Note - Never install forensics tools on a suspect’s computer, because you’re influencing!</li>\n<li>Capture memory - don’t store it on desktop. usually will want to store on a shared network. Naming - operation + serial number or date + .mem. You can decide to include pagefile</li>\n<li>Add evidence item - you can copy external sources</li>\n<li>Take a look - find root -> $MFT master file table. You can export it from this tool</li>\n<li>Create disk image, pick encase (E01) as format or raw (DD)</li>\n</ul>\n<h4>Physical memory - system memory (RAM) - short term memory</h4>\n<p>You can get…</p>\n<ul>\n<li>All running processes at time of snapshot</li>\n<li>All loaded modules and DLL’s including malware</li>\n<li>Running device drivers, including rootkits</li>\n<li>Open files for each process, including path to file on disk</li>\n<li>Open registry keys for each process</li>\n<li>Open network sockets including IP address</li>\n<li>Decrypted versions of data</li>\n<li>Contents of windows</li>\n<li>Keystrokes</li>\n<li>Email attachments, file transfers</li>\n<li>Cryptographic key material</li>\n<li>WEP and WPA wireless keys</li>\n<li>Usernames/passwords</li>\n</ul>\n<h4>Analyzing Memory Dumps</h4>\n<ul>\n<li>Look for a printable string</li>\n<li>Reconstruct internal data structures</li>\n<li>Search for static signatures of kernal data structures</li>\n</ul>\n<h4>Volatility</h4>\n<ul>\n<li>Advanced memory forensics framework</li>\n<li>Plugins - malfind, csrpslist, orphan threads, PSList, PSScan, svcscan, ldrmodules, impscan, apihooks, idt, gdt, callbacks, driverirp, psxview, ssdt<em>ex, ssdt</em>by_threads</li>\n<li>Yara - Malware plugins for Volatility</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">volatility.exe -h    // shows options\nvolatility.exe -f nameofmemorydump pluginname\nvolatility.exe -f nameofmemorydump --profile=Win7SPOx86 pluginname</code></pre></div>\n<p><em>Plugins:</em>\n<code class=\"language-text\">imageinfo</code> - tells us windows operating systems. image date and time - when you took the memory dump\n<code class=\"language-text\">psscan</code>\n<code class=\"language-text\">dlllist -p &lt;processid&gt;</code>\n<code class=\"language-text\">netscan</code>\n<code class=\"language-text\">Deskscan</code> -\n<code class=\"language-text\">Getsids</code> - see which user rights the malware was running</p>\n<h4>Windows Registry</h4>\n<ul>\n<li><code class=\"language-text\">regedit</code> in run window</li>\n<li>HKEY (handle to a key). Most important are <code class=\"language-text\">HKEY_USERS</code> (HKU) - profile of users (internet browsing history, last accessed files, etc), <code class=\"language-text\">HKEY_LOCAL_MACHINE</code> (HKLM)\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/87791a29882b11a34ebbf788ee275572/4f5b3/registry.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 291px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 79.03780068728523%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAADEUlEQVQ4y52S20sUYRjG518oqMD7LrsqqPAmb0KILjpQKeJFYGrioQgFS/F0oWWJZpIgnaBCkP6CrrU0a13X3dnjzOwcdg47M7utGrqHp/ebXRUv8qIPHr73m8Pve94DV1P/EFeaulHfOYC2Jy/Q+ngcLb3P0NQzhobOQdR3DOJSXReqqu/gxPmbOH7uOo6d3dO1isrn4ySuprkXp+8242pjOxraenD73qOKulFbdx+1t1pw5nIjuKpqcCcvHK1TF8HdaO3H6OxHTL5ZwNTbBUzMzePp608YefkeQ1MfMDD5Dt2js+gamcGD4Rl0Db/y1DE4jc6hctw5NL0vrn1gGtF4CnwsBUl1sRYQkJBdRBMG1oMiRCULIWkjHNPomY5QRIGkZJCkbzd4GXHBhOUWYdq7pDwB+yegW1nEJQOBkI6EqEGSDYgkFguSDkVLl5Uq72rKhma4kDULsmp5/+tmBikS1zc2AwdAWLHwed6HaEyAz+fDr5+rWCUtLS0ik83i6FXa37n2vudeWCjksbX9B9l0AL9dEZKkIhKNQjcMOI4LXddhUKxpKTi27e3snMlkyqhSCcVikRyOz1UeFJEvApvpZWy6PDRKTxJFpOlny7IgCAIURYEoSQSjUiQE75JcLncYuOQXvAMD7uwCW/YPAoaRlHXwPA+TYMxJOMxjbX0DwVAYadOAqqlY8wdgpu0DIIn78nWFncoOCwR0/NjKJghERZdl2I4Dm6WoqgRJkds0TLrANE1IyfJ7BmLLc/h9PYQSBZ7DPJCzlpBzgpSiSq7ClLoOlcAsTVlWvH1leQVyUkQkEsO3xUWCugfABN1WrACZw2234tB0kEwmvY+ZGxYzIKtZoVDAzs7OvvL5/AEwQB/tAXfzrCkr5DAEWTHIQZhSp+ZQIyKRKOLxhAf71/KAkqodArKmbGWj5EYnQJwaYtLYOIjHogjyEWpUhOqpeI1il/hpZhVilBtLTVG0PWAJBRqb7QxPQBqXNE1+SqM5y3qFN2hEVG/2LLh0ZrPJGsRq6rjuAVCuAA9P/P8txvkL/uNLqQsdAo4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Registry Editor\"\n        title=\"\"\n        src=\"/static/87791a29882b11a34ebbf788ee275572/4f5b3/registry.png\"\n        srcset=\"/static/87791a29882b11a34ebbf788ee275572/cde50/registry.png 148w,\n/static/87791a29882b11a34ebbf788ee275572/4f5b3/registry.png 291w\"\n        sizes=\"(max-width: 291px) 100vw, 291px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n</ul>\n<p>To enter the password, right click the file, 7-zip menu -> extract files.  Should bring up a dialog box that you can enter the password into</p>\n<p>Was able to find the password for the archive and getr the target list\nWorking on analyzing the malware now.</p>\n<p>I figured out what the malware is doing, but have been searching for the passwords for a long time.\nhas anyone seen Ida anywhere on the VM? The instructor said It is there somewhere.</p>\n<p>I mounted the image<em>USB</em>mayflower.001 to a drive, and then use photorec to recover the files, but they dont look the same as shown in the lecture videos\nthe file names are like f041231.jpg or something, no korean fonts\nsome files are probably equivalent as the file size and type matches one of those 6 shown files in the lecture vid\nam i missing an entire step?</p>\n<p>Antonio Piazza [7:20 AM]\nNo,  they didn’t show the photorec’d direcory in the shot of the lecture you are thinking of… They showed the image mounted in OFS.  You are seeing what you are supposed to after using photorec.</p>\n<p>Did you run the malware, or were you able to answer all the questions from static analysis?</p>\n<p>Antonio Piazza [7:21 AM]\nStatic Analysis.  Use McAfee Insite.  </p>\n<p>i think i’m misunderstanding the task objective\n“display the list of usernames/passwords”\nwhose are these? the cyber target’s ? (edited)\ni found a bunch of ip and pw but from what i understand the question, those aren’t the correct ones\nor am i over reading?</p>\n<p>Lydia Batchelor [8:39 AM]\nWell there’s the password to open the zip file\nAnd then there’s the list of usernames and passwords which is separate</p>\n<p>brian_tsui [8:41 AM]\nther’es only 1 csv file inside , and i read it so many times i’m not noticing any password\nor, i can’t tell that which cell is a password</p>\n<p>Lydia Batchelor [8:42 AM]\nYeah they’re not in there\nDid you watch the lecture hints?\nI made more progress after rewatching those a second time</p>\n<p>He tells you in there where to look for the username and password list</p>\n<p>brian_tsui [8:49 AM]\nhe said “search for those letters” , letters as in the file name as shown in the skull image\nsearch… where though?</p>\n<p>Lydia Batchelor [8:50 AM]\nHe tells you that in a different hint</p>\n<p>mmm nothing is making sense: “the file names are actually domain name used internally for that company” , why would some korean legit company use domain name that’s based on a zip file name that the hackers in 2014 named?\nor is “that company” means the attacker?\nhe also did say that the malware contains the password\ni searched through the malware’s string dump for the “filename from the skull image” and nothing hits\nso, i heard clearly the hint, but i’m completely misunderstanding, it seems</p>\n<p>Lydia Batchelor [9:17 AM]\nHave you explored any of the plugins in InSight?</p>\n<p>brian_tsui [9:24 AM]\nwhat are considered as “plugin”?\nthe password crackers in the usb with chinese names?\nwait no, those are in the unpartitioned part of the usb\nthose wont be relevant\nyou mean the other evil processes that the .bin malware calls after it launches?</p>\n<p>Lydia Batchelor [10:07 AM]\nNo I mean the plugins you can use in InSight to examine the bin file</p>\n<p>Antonio Piazza [10:56 AM]\nWeek one lecture discusses using insite plugins. Everything you need to know for the challenge the lecture pertaining to the challenge tells you.</p>\n<p>ricciarn [11:08 AM]\nI still need to finish the lectures, but are you guys referring to optional parts of week 2?  Or are these required for the lectures?\nAlso, can anyone send me the link to the downloadable lectures?  I’m not trying to distribute them, but it would be much easier to watch them on my 2 hours per day on the train.</p>\n<p>Lydia Batchelor [11:19 AM]\nYeah there’s a challenge at the end that we don’t have to turn in a lab for or anything but which you can address in your writeup (edited) </p>\n<p>grivasjw [12:12 PM]\nI pinned my OneDrive folder that has the lectures. I am about to remove the week 1 lectures to make room for the week 3 though. Does anyone still need the week 1 lectures? If so, I’ll leave them.</p>\n<p>jd [1:23 PM]\nWas the lab/challenge you all are talking about from the first set of videos or the second set? I had some things come up this week that delayed me keeping up with the videos, but plan on getting through them today.\nJust saw the first set had a lab refering to imagerlite.zip…is that the one everyone is doing?</p>\n<p>Lydia Batchelor [1:24 PM]\nSecond. The other labs are just more just to walk through alongside</p>\n<p>Kevin [5:53 PM]\nSo how were you guys able to determine what the malware does just through static?  I ran the strings and got the list of a bunch of bad news .exe’s , but not really anything that would describe what would happen when the malware is run.</p>\n<p>Adam [6:38 PM]\nFileInsight helped me a lot, as well as just looking around at what was stored and where. I also found a .cpp file that was pretty instructive and Notepad++ was good enough there.\nAlso there were some really horrible passwords in there… “123456” “qwerty”…I’ve only been that lazy for devices without net connectivity. :sweat_smile:</p>\n<p>brian_tsui [8:48 PM]\nyes i’ve used the insight over and over, i’ve been reading string by string,\ni only noticed the “password:“%s\"\" line but what significance does that have?\nwhere is the string to be substituted into the %s place holder?</p>\n<p>Adam [8:59 PM]\nIt might just have to do with which parts of the drive you’re looking at. When I recovered the whole drive’s files it had a bunch of .zip folders I had to extract to see stuff (7-zip is the name of the zip utility installed I believe).</p>\n<p>brian_tsui [9:02 PM]\ni found all of those already\ni found a bunch of ip and passwords from those, but those aren’t the ones relevant to the target\nthis specific targets which is a south korean company\nunless i’m misunderstanding the task of the challenge?</p>\n<p>Adam [9:52 PM]\nIs the target not Sony?</p>\n<p>brian_tsui [10:09 PM]\nFrom what i understand,  the deleted file was the sony case, the mayflower operation case is not? According to the zip file in the partitioned part with a pass lock</p>\n<p>Adam [10:21 PM]\nWell there’s the image that threatens Sony from the recovered files in the usb image. Additionally he says that the malware is from the Sony case in the video iirc.</p>\n<p>brian_tsui [10:24 PM]\nI heard that too,  but isnt mayflower another case that borrows the payload used on sony 2014?\nOr part of it?</p>\n<p>Adam [10:27 PM]\nSeems like part of it to me although tbh I was more concerned with seeing how the file recovery worked and just looking through all the files it found than specifically analyzing the malware. I found a .cpp file that seemed to do a pretty good job of spelling out what was happening so I just was happy with that.</p>\n<p>brian_tsui [10:32 PM]\nCan we confirm that the cpp is actually involved in mayflower’s payload?</p>\n<p>Adam [10:33 PM]\nWhat do you mean?</p>\n<p>brian_tsui [10:34 PM]\nDid the .bin malware actually call the cpp executable which is a password cracker</p>\n<p>Adam [10:35 PM]\nDid you find anything on the USB stick to suggest it was unrelated? I’m just a little unclear on the notion that the majority of the data is bogus or something. Pretty much all of it seemed to do with ip, username, and password logging to me.\n.cpp files aren’t executables</p>\n<p>brian_tsui [10:36 PM]\nYes the executable is probably one of the exe in the same folder\nBut it is in the unpartitioned part of the usb,  which,  in a normal case,  its just a previous file stored in the usb before the attacker deleteed those unneeded files,  and store the mayflower ones\nThe unpartioned parts can be used,  but not neceearily,  mostly depend on the strategy of the attack.  Were they used or were they just sitting in the usb disk,  thats something i believe we need to confirm</p>\n<p>Adam [10:45 PM]\nHow would you confirm a particular executable’s source code? Afaik decompilers can’t replicate code exactly because they won’t create things like code that wasn’t optimized via the compiler originally used. Again I didn’t go super in depth because the lab wasn’t a required write up, so I just went in today and spent a couple of hours to get a sense of it and tried to answer the 6 questions at a high level. I’m not saying you couldn’t confirm the things you’re asking, but I do agree that a static analysis would likely not be enough, and even if you were to say compile that cpp program and run it and compare it to some of the other exes, it still would only be circumstantial.</p>\n<p>brian_tsui [10:49 PM]\nI looked thru the cpp,  the comments are in chinese and i can read them,  its for cracking password.  I also tried a few of the exe around the folder,  the chinese names are quite literal,  the short english ones,  i gave those a try too,  without full analysis,  some gives a UI for password cracker user,  some instantly dig your windows and send html requests</p>\n<p>Adam [10:49 PM]\nAlso I did just pull it up and recovered only things from the partition. The DUBrute folder seems much like the rest of it, and perhaps that’s more of what you’re looking for? Either way that’s on the part of the disk that was partitioned and has ips, passwords and at least a small username file.\nAs far as linking it directly to the case without knowing what usernames, passwords, and ips were in use by Sony at the time I’m not sure you can definitively say which is which…\nThe drive is corrupted upon receipt, so all of the data you’ll find is reconstructed. I guess I’m just a little confused at what else you want to find? The lab’s questions mostly have to do with the recommendations you’d give to the company…I don’t think you can or have to make a legal case from this information alone. For a legal case you would need to observe this malware on Sony’s systems, note logs where it sends sensitive data out, etc.</p>\n<p>brian_tsui [11:22 PM]\nI’m coming from the idea that the zip in the partitioned part with a lock,  theres a csv in it,  and the lecture said that thats the answer to q.1, who the cyber targets are.  I didnt quite know if “cyber targets” means the attackers,  or the victims,  i googled the term a bit and concluded it is the victims.  Which is why i got the idea that the victim of this attack aimed at the korean companies listed in the csv file,  s-oil company.  It doesnt seem to have anything to do with Sony</p>\n<p>Adam [11:47 PM]\nSo then its probably safe to conclude that its that company with Sony-like malware then right? I missed that hint completely so looking into it now. I’m still a little unclear on what you’re asking since it seems like you already have the answer.</p>\n<p>brian_tsui [12:17 AM]\nnah i dont, i’m trying to find that answers that @Lydia Batchelor and @Antonio Piazza found\nsuppose there are some password of the korean cyber target, we know the ip and username easily, suppose the password is “inside the malware”, referring to the .bin in the partitioned memory of the usb. I used fileInsight plugins since 3 days ago and have been reading the strings over and over , and i can’t figure out the passwords are.\nA broader question that may or may not matter, is the intention of this mayflower attack is. Is the USB retrieved after a physical contact with the victim’s machine, carrying data on the way back to north korea? is that why the “passwords of the victims” are “in the malware”? what’s the purpose of storing string data in the malware executable, when the attacker is gonna retrieve the USB by hand… it only makes it difficult for himself / herself to get the needed data for the client.</p>\n<p>Adam [12:24 AM]\nYeah I’m lookin in the bin file. I think hint 3 might be morehelpful than you think.</p>\n<p>brian_tsui [12:24 AM]\nwait, arent there only 2 hints?</p>\n<p>Adam [12:25 AM]\nAs far as the second question I would assume that if caught the attacker wouldn’t want it immediately apparent where the data was, which is similar to how they hid the .zip password.\n6:45 in the last video is hint 3</p>\n<p>brian_tsui [12:26 AM]\noh right okay i see which one</p>\n<p>Adam [12:26 AM]\nbasically there are clues in that you were hacked by GOP picture as to the location of the usernames and passwords\nI haven’t put that to much use yet, but it is hinted.</p>\n<p>brian_tsui [12:27 AM]\nyes that’s what i’m having trouble understanding, or i’m likely totally misunderstanding, i spent the whole day yesterday on several directions from that hint</p>","frontmatter":{"title":"Thoughts on Forensics (Defense of the Dark Arts)","date":"January 18, 2019","tags":["school","security"]}}},"pageContext":{"slug":"/security-forensics/","previous":{"fields":{"slug":"/security-malware/"},"frontmatter":{"title":"Thoughts on Malware (Defense Against the Dark Arts)","tags":["school","security"]}},"next":null}}