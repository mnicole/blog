{"data":{"site":{"siteMetadata":{"title":"Thoughts on Things","author":"Michele Larson"}},"markdownRemark":{"id":"ea6ffb1f-ab7a-594a-94c8-9615384afbc4","excerpt":"This week focuses on life as a malware researcher and covers how the attack gets into the system, how it typically functions, and how we can defend against it…","html":"<p>This week focuses on life as a malware researcher and covers how the attack gets into the system, how it typically functions, and how we can defend against it.</p>\n<h4>Spreading malware</h4>\n<h5>First contact - Possible Sources</h5>\n<ul>\n<li>Email, Instant Messaging</li>\n<li>Malvertising - contaminated ads</li>\n<li>Poisoned search results - Trow up sites based on google trends that would show up high in search results that people would then click on</li>\n<li>Watering hole - go to the place where people mostly go and poison one place</li>\n<li>Physical access - such as USB drives</li>\n</ul>\n<h5>Local Execution</h5>\n<ul>\n<li>Autorun - Windows will automatically run software</li>\n<li>Exploitation of a document or file - PDF, plugin, browser</li>\n<li>Reverse psychology/social engineering - “don’t click here” “click to claim your prize”</li>\n</ul>\n<h5>Establish Presence</h5>\n<ul>\n<li>Tries to blend in and hide (change filenames or datetime stamp, sign files)</li>\n<li>Tries to appear legitimate</li>\n<li>Persists (system startup, application start up, scheduled tasks, etc)</li>\n</ul>\n<h5>Attack</h5>\n<ul>\n<li>Harvest information</li>\n<li>Phone home - use web, email, FTP to send data</li>\n</ul>\n<h4>Defenses</h4>\n<ul>\n<li>User education</li>\n<li>Block computer ports</li>\n<li>Anti-virus/malware</li>\n<li>Network Firewall/Inreusion Prevention</li>\n<li>Message/Network/Web Reputation</li>\n<li>Host Firewall</li>\n<li>Host IPS</li>\n<li>Access control</li>\n</ul>\n<h5>Anti-malware features</h5>\n<ul>\n<li>File Scanning</li>\n<li>Registry and Cookies</li>\n<li>Cloud scanning</li>\n<li>Memory scanning</li>\n<li>Scripts</li>\n<li>Heuristics</li>\n<li>Decomposition</li>\n<li>Configuration: Exclusions, sensitivity, reporting</li>\n</ul>\n<h4>Yara</h4>\n<ul>\n<li>language that lets you search for patterns in your scans</li>\n<li>strings - <code class=\"language-text\">&quot;in quotes&quot;</code> params: <code class=\"language-text\">nocase</code>, <code class=\"language-text\">wide</code>, <code class=\"language-text\">wide ascii</code>, <code class=\"language-text\">fullword</code></li>\n<li>Byte patterns (hex strings) <code class=\"language-text\">{}</code> params: <code class=\"language-text\">?</code> <code class=\"language-text\">??</code> are wildcards <code class=\"language-text\">{E2 34 ?? C8 A? FB}</code></li>\n<li>conditions are boolean operators, arithmetic, and bitwise <code class=\"language-text\">($a == 6 or $b)</code> <code class=\"language-text\">#a == 6 and #b &gt; 10</code> <code class=\"language-text\">$a at 100 and $b at 200</code></li>\n</ul>\n<p>example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">rule myRule {\n    strings:\n        $a = &quot;win.exe&quot;\n        $b = badfile1.exe\n        $c = badfile2.exe\n    condition:\n        $a and ($b or $c)\n}</code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d6c8310b7e03f48b679c26b2f70516c0/26c84/yara.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 49.33554817275748%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABS0lEQVQoz32S666CQAyE8YoX5CKKKIpX1BA1vP/L9fhNssYTjT8mu9m20+lsvaZp7Hg82ul0srqu7fF42G63s8vlYtfr1RaLhY3HYxuNRjo9z/uN7XYrgvl8bv1+37rdrgK9Xk9kWZYptlwubb1e22q1siRJ9N7pdD4JB4OBRVGkBE6XxPv5fJZySCCrqkrg7XA4GGImk8l/wjCMXqrewYhYgXpIhsOh8lqtlrXb7dcUH7V0CIJAcIkAgs1mI2W3201q8jwXmII4wCam4S6Pi2dB/vRqv98r6AjpTvF0OhUxHmJLURRqkqaplWUpn8lDkAh935fp+BXHschQSleIKMQvfKRwNpupObm8kQMpjeHx8CoMQ/0coBMkWEEhKjjx0t0hY4Kva8PPfgui8H6/azc52Ve3Wu6DvhIy8vtnOFCAZ24URkU5U/xa7D+P7+oXt1IKBgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Yara\"\n        title=\"\"\n        src=\"/static/d6c8310b7e03f48b679c26b2f70516c0/fb8a0/yara.png\"\n        srcset=\"/static/d6c8310b7e03f48b679c26b2f70516c0/1a291/yara.png 148w,\n/static/d6c8310b7e03f48b679c26b2f70516c0/2bc4a/yara.png 295w,\n/static/d6c8310b7e03f48b679c26b2f70516c0/fb8a0/yara.png 590w,\n/static/d6c8310b7e03f48b679c26b2f70516c0/26c84/yara.png 602w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<h4>Automated Analysis</h4>\n<ul>\n<li>Automation is hard, but there is so much malware that you really need to automate some of it.</li>\n</ul>\n<h4>Cuckoo</h4>\n<ul>\n<li>Automated analysis - You tell it what VMs to run and when you upload a sample, it will run it on the VMs and report the results.</li>\n<li>The host controller of <a href=\"http://docs.cuckoosandbox.org/en/latest/introduction/what/\">Cuckoo</a> tells each VM how to run the file. It will create the process, inject its DLL (randomly named to avoid detection) into the process, and then trace the Win32 API calls which then it can report back.</li>\n<li>It also reports files being created, deleted, and downloaded by the malware; memory dumps of the malware processes; network traffic trace; screenshots of Windows desktop; full memory dumps of the machines</li>\n</ul>\n<hr>\n<h4>Lab</h4>\n<p>We are given some sample files to analyze using Cuckoo. I chose to write about the last file:</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b0c184f694330c10af6d35ceadf9c996/5d9c9/cuckoo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 96.9230769230769%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsSAAALEgHS3X78AAACjklEQVQ4y3WU13KaQQyF95rQe+8dfprpJBkSxwETD2Mnef9XkffTWAw3vtDsImmPjo7E7za7gzSbTel2e2qdblcq1apEojGJekul0nqPRKL+NIvJl3BEYrG4nuGIWVTc6XyRlgccj8eyWCxkOp1ogVQqJZl0WorFomQyGSmXy5LNZiX7cc/n81KpVCSXy+m9VCpJMpkU9/h0kopPIKnqmWG1Wk2TW62WGgXwcdbrdS2G4dPCvkjaF+d019c3z2oqw9FINpuNLJdLNXyr1Urm87kEQSCz2UyOx6MMh0P93e/39U5n5FIoHo+LOz//UScPYQBD2BYKBWk0GsoCo3XY2kmuxbnTsgJeXq5aHaOKAQAIMI/NV/6QBs2Io58VgwinO3mGk8lEaQPa6/VUP4L3gPgYCkwSiYTqZcPixI+53x7w4WGheq3X65tm7XZbdUKOTqdzmzZGazYI/EyXYnSoDIeDgT4a+BNGVGJ6POBuLcKMh1G/i9wxYhQgH7bu+vZPAs8CsJGfNCcSAEz7TBKfse36xac4vzFi+LgD6o4/f2kCbdqE0QwmsLpfXuK0io8Y7MmjbXK05cP3401wmxytftYyPmsZ7Yhx4tMpv/79ry1aq7QIY3aLthnSvRwW426aW0f612MPg2CsYEzaVghDht1up/8gzu12e9uE/X6v2gGCTMbcnS8vOmWYAYbw3KnMAx7DCuOfATsbFkAMg8JIFQqFxP14fJKaF7vhE+8f2kfCwAHBiAHC3WRBZxvSrWWY8PlioUkCGMD7tcCMOYXIJc++SpBwh6/fFMg+EFQGCCasgQ0Ds48HYGhMLuC85Y0CzucLDfKQKgBBnSDrBAvWAdFt5+y/i4ZoxwqFw2G1dwCxE6FPJEQ+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Running Cuckoo\"\n        title=\"\"\n        src=\"/static/b0c184f694330c10af6d35ceadf9c996/fb8a0/cuckoo.png\"\n        srcset=\"/static/b0c184f694330c10af6d35ceadf9c996/1a291/cuckoo.png 148w,\n/static/b0c184f694330c10af6d35ceadf9c996/2bc4a/cuckoo.png 295w,\n/static/b0c184f694330c10af6d35ceadf9c996/fb8a0/cuckoo.png 590w,\n/static/b0c184f694330c10af6d35ceadf9c996/5d9c9/cuckoo.png 650w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>Cuckoo outputs a series of csv files in the /logs folder that detail everything the malware did. I start here reading the logs since I see the processes happened from “bad” (which is what it’s configured to run on):</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/97bc47966f413cacbdc93c41f9d9b522/4e157/doc1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 68.43137254901961%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/0lEQVQ4y51SO2/UQBD2vwfE8VRCBIgCikABERFFaAKIDlHRpkvO3rXXj10/7nzoTvqYb7w5XASKFKO1Z3e+x8wkX86/4vTjKd6ffMKbtydYPH2JRwevsHjyQuI57iwOcO/hMzkPcffBYfw/0pO5+4+P8Pr4A76df8evz2dIjn84vPtZ4dI2WA09vPdYrVZYr9fYbDbYbrf6PY4j+mGQNyuM6xG73Q5d16HvB3n3G00IqCSSiyuLi0uLqvbwwcO5Qr5rNE2D5fIKxmTI8xx1U8NYg7IsJb9EJnnGMk2VaBTS0uVIijyDyw28AFCdc06Kp+9UHmdZqrnGN8gLAa6rPZi1Vkis3Hl0fSdkDgkvjDGq6GbADMWNgEYBGam8qaoKZVUiMbcBzGYKpdZL7waxzXYl1pKJgF4v2COCB+knC0noJOf3gLWCqELpLS1THQHVciGoVBVCi7ZrtSC0rUywRVEUyspcKzlaCmFywTuSa38bbsagQhImGCy4BmwVsMNENk2dOSrZA0qU7JuA8uR7ukhog2sRxC6DRZPlEC2bv0BiSS1Li67reE+1BIxDMXEo0x6WamHqYSorwx4W/1ubOG0OUQFtbmMiKuRQ5HKuUIciBGxBExecw6BC1hK8EiLGTOHt1ibTHYxD45SVbW65jIAzy+5fi51bPQmmeyi1fwDRbAfI79mkeAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Log 1\"\n        title=\"\"\n        src=\"/static/97bc47966f413cacbdc93c41f9d9b522/fb8a0/doc1.png\"\n        srcset=\"/static/97bc47966f413cacbdc93c41f9d9b522/1a291/doc1.png 148w,\n/static/97bc47966f413cacbdc93c41f9d9b522/2bc4a/doc1.png 295w,\n/static/97bc47966f413cacbdc93c41f9d9b522/fb8a0/doc1.png 590w,\n/static/97bc47966f413cacbdc93c41f9d9b522/526de/doc1.png 885w,\n/static/97bc47966f413cacbdc93c41f9d9b522/4e157/doc1.png 1020w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>I see that it is writing a file, moving files, </p>\n<p>The malware tries to find out information about a prints.exe file (NtQueryDirectory) as well open the file and another file ntshruis2.dll from <code class=\"language-text\">C:\\Users\\Admin\\AppData\\Local\\Temp\\</code>. It also creates a registry key in the Session Manager and tries to open various registry keys. It later successfully creates the prints.exe and ntshruis2.dll files, as well as a Deleteme.bat file in <code class=\"language-text\">C:\\Users\\Admin\\AppData\\Local\\Temp\\</code>.</p>\n<p>creates a file, prints.exe as well as . It also adds a </p>\n<p>Other findings from cuckoo - Reading a key for Windows Error Reporting, CodeIdentifiers</p>\n<p>Looking at the strings, I see SOFTWARE\\Borland\\Delphi\\RTL</p>\n<p>Knowing about the files it creates and where they are stored, I open up the Temp directory before running the malware. </p>\n<p>I also see a file called <code class=\"language-text\">qinput.png</code> which I translate using my phone. It looks like a login screen:</p>\n<div class=\"gatsby-highlight\" data-language=\"re-register\"><pre class=\"language-re-register\"><code class=\"language-re-register\">Dear User:\nSince your network is unstable, please login:\n[input]\nPassword:\n[input]\n[Login] [Cancellation]</code></pre></div>","frontmatter":{"title":"Thoughts on Security Defenses (Defense of the Dark Arts)","date":"January 26, 2019","tags":["school","security"]}}},"pageContext":{"slug":"/security-defenses/","previous":{"fields":{"slug":"/security-forensics/"},"frontmatter":{"title":"Thoughts on Forensics (Defense of the Dark Arts)","tags":["school","security"]}},"next":null}}